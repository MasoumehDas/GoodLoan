import { EditorState } from 'prosemirror-state';
import { EditorView } from 'prosemirror-view';
import { Subject } from 'rxjs';
import { isNil } from 'ngx-editor/utils';
import EditorCommands from './EditorCommands';
import defautlSchema from './schema';
import { parseContent } from './parsers';
import getDefaultPlugins from './defaultPlugins';
const DEFAULT_OPTIONS = {
    content: null,
    history: true,
    keyboardShortcuts: true,
    inputRules: true,
    schema: defautlSchema,
    plugins: [],
    nodeViews: {}
};
class Editor {
    constructor(options = DEFAULT_OPTIONS) {
        this.valueChangesSubject = new Subject();
        this.updateSubject = new Subject();
        this.options = Object.assign({}, DEFAULT_OPTIONS, options);
        this.createEditor();
    }
    get valueChanges() {
        return this.valueChangesSubject.asObservable();
    }
    get update() {
        return this.updateSubject.asObservable();
    }
    get schema() {
        return this.options.schema || defautlSchema;
    }
    get commands() {
        return new EditorCommands(this.view);
    }
    setContent(content) {
        if (isNil(content)) {
            return;
        }
        const { state } = this.view;
        const { tr, doc } = state;
        const newDoc = parseContent(content, this.schema);
        tr.replaceWith(0, state.doc.content.size, newDoc);
        // don't emit if both content is same
        if (doc.eq(tr.doc)) {
            return;
        }
        if (!tr.docChanged) {
            return;
        }
        this.view.dispatch(tr);
    }
    handleTransactions(tr) {
        const state = this.view.state.apply(tr);
        this.view.updateState(state);
        this.updateSubject.next(this.view);
        if (!tr.docChanged && !tr.getMeta('FORCE_EMIT')) {
            return;
        }
        const json = state.doc.toJSON();
        this.valueChangesSubject.next(json);
    }
    createEditor() {
        var _a;
        const { options } = this;
        const { content = null, nodeViews } = options;
        const { history = true, keyboardShortcuts = true, inputRules = true } = options;
        const schema = this.schema;
        const doc = parseContent(content, schema);
        const plugins = (_a = options.plugins) !== null && _a !== void 0 ? _a : [];
        const defaultPlugins = getDefaultPlugins(schema, {
            history,
            keyboardShortcuts,
            inputRules
        });
        this.view = new EditorView(null, {
            state: EditorState.create({
                doc,
                schema,
                plugins: [...defaultPlugins, ...plugins,],
            }),
            nodeViews,
            dispatchTransaction: this.handleTransactions.bind(this)
        });
    }
    registerPlugin(plugin) {
        const { state } = this.view;
        const plugins = [...state.plugins, plugin];
        const newState = state.reconfigure({ plugins });
        this.view.updateState(newState);
    }
    destroy() {
        this.view.destroy();
    }
}
export default Editor;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRWRpdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2xpYi9FZGl0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLFdBQVcsRUFBdUIsTUFBTSxtQkFBbUIsQ0FBQztBQUNyRSxPQUFPLEVBQWUsVUFBVSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDM0QsT0FBTyxFQUFjLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUUzQyxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFFekMsT0FBTyxjQUFjLE1BQU0sa0JBQWtCLENBQUM7QUFDOUMsT0FBTyxhQUFhLE1BQU0sVUFBVSxDQUFDO0FBQ3JDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDekMsT0FBTyxpQkFBaUIsTUFBTSxrQkFBa0IsQ0FBQztBQWVqRCxNQUFNLGVBQWUsR0FBWTtJQUMvQixPQUFPLEVBQUUsSUFBSTtJQUNiLE9BQU8sRUFBRSxJQUFJO0lBQ2IsaUJBQWlCLEVBQUUsSUFBSTtJQUN2QixVQUFVLEVBQUUsSUFBSTtJQUNoQixNQUFNLEVBQUUsYUFBYTtJQUNyQixPQUFPLEVBQUUsRUFBRTtJQUNYLFNBQVMsRUFBRSxFQUFFO0NBQ2QsQ0FBQztBQUVGLE1BQU0sTUFBTTtJQUlWLFlBQVksVUFBbUIsZUFBZTtRQUt0Qyx3QkFBbUIsR0FBRyxJQUFJLE9BQU8sRUFBVyxDQUFDO1FBQzdDLGtCQUFhLEdBQUcsSUFBSSxPQUFPLEVBQWMsQ0FBQztRQUxoRCxJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLGVBQWUsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUMzRCxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7SUFDdEIsQ0FBQztJQUtELElBQUksWUFBWTtRQUNkLE9BQU8sSUFBSSxDQUFDLG1CQUFtQixDQUFDLFlBQVksRUFBRSxDQUFDO0lB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QUNGLFNBQVM7WUFDVCxtQkFBbUIsRUFBRSxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztTQUN4RCxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsY0FBYyxDQUFDLE1BQWM7UUFDM0IsTUFBTSxFQUFFLEtBQUssRUFBRSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7UUFDNUIsTUFBTSxPQUFPLEdBQUcsQ0FBQyxHQUFHLEtBQUssQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFFM0MsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLFdBQVcsQ0FBQyxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUM7UUFDaEQsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDbEMsQ0FBQztJQUVELE9BQU87UUFDTCxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQ3RCLENBQUM7Q0FDRjtBQUVELGVBQWUsTUFBTSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU2NoZW1hIH0gZnJvbSAncHJvc2VtaXJyb3ItbW9kZWwnO1xuaW1wb3J0IHsgRWRpdG9yU3RhdGUsIFBsdWdpbiwgVHJhbnNhY3Rpb24gfSBmcm9tICdwcm9zZW1pcnJvci1zdGF0ZSc7XG5pbXBvcnQgeyBFZGl0b3JQcm9wcywgRWRpdG9yVmlldyB9IGZyb20gJ3Byb3NlbWlycm9yLXZpZXcnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuXG5pbXBvcnQgeyBpc05pbCB9IGZyb20gJ25neC1lZGl0b3IvdXRpbHMnO1xuXG5pbXBvcnQgRWRpdG9yQ29tbWFuZHMgZnJvbSAnLi9FZGl0b3JDb21tYW5kcyc7XG5pbXBvcnQgZGVmYXV0bFNjaGVtYSBmcm9tICcuL3NjaGVtYSc7XG5pbXBvcnQgeyBwYXJzZUNvbnRlbnQgfSBmcm9tICcuL3BhcnNlcnMnO1xuaW1wb3J0IGdldERlZmF1bHRQbHVnaW5zIGZyb20gJy4vZGVmYXVsdFBsdWdpbnMnO1xuXG50eXBlIEpTT05Eb2MgPSBSZWNvcmQ8c3RyaW5nLCBhbnk+O1xudHlwZSBDb250ZW50ID0gc3RyaW5nIHwgbnVsbCB8IEpTT05Eb2M7XG5cbmludGVyZmFjZSBPcHRpb25zIHtcbiAgY29udGVudD86IENvbnRlbnQ7XG4gIGhpc3Rvcnk/OiBib29sZWFuO1xuICBrZXlib2FyZFNob3J0Y3V0cz86IGJvb2xlYW47XG4gIGlucHV0UnVsZXM/OiBib29sZWFuO1xuICBzY2hlbWE/OiBTY2hlbWE7XG4gIHBsdWdpbnM/OiBQbHVnaW5bXTtcbiAgbm9kZVZpZXdzPzogRWRpdG9yUHJvcHNbJ25vZGVWaWV3cyddO1xufVxuXG5jb25zdCBERUZBVUxUX09QVElPTlM6IE9wdGlvbnMgPSB7XG4gIGNvbnRlbnQ6IG51bGwsXG4gIGhpc3Rvcnk6IHRydWUsXG4gIGtleWJvYXJkU2hvcnRjdXRzOiB0cnVlLFxuICBpbnB1dFJ1bGVzOiB0cnVlLFxuICBzY2hlbWE6IGRlZmF1dGxTY2hlbWEsXG4gIHBsdWdpbnM6IFtdLFxuICBub2RlVmlld3M6IHt9XG59O1xuXG5jbGFzcyBFZGl0b3Ige1xuICBwcml2YXRlIG9wdGlvbnM6IE9wdGlvbnM7XG4gIHZpZXc6IEVkaXRvclZpZXc7XG5cbiAgY29uc3RydWN0b3Iob3B0aW9uczogT3B0aW9ucyA9IERFRkFVTFRfT1BUSU9OUykge1xuICAgIHRoaXMub3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sIERFRkFVTFRfT1BUSU9OUywgb3B0aW9ucyk7XG4gICAgdGhpcy5jcmVhdGVFZGl0b3IoKTtcbiAgfVxuXG4gIHByaXZhdGUgdmFsdWVDaGFuZ2VzU3ViamVjdCA9IG5ldyBTdWJqZWN0PEpTT05Eb2M+KCk7XG4gIHByaXZhdGUgdXBkYXRlU3ViamVjdCA9IG5ldyBTdWJqZWN0PEVkaXRvclZpZXc+KCk7XG5cbiAgZ2V0IHZhbHVlQ2hhbmdlcygpOiBPYnNlcnZhYmxlPEpTT05Eb2M+IHtcbiAgICByZXR1cm4gdGhpcy52YWx1ZUNoYW5nZXNTdWJqZWN0LmFzT2JzZXJ2YWJsZSgpO1xuICB9XG5cbiAgZ2V0IHVwZGF0ZSgpOiBPYnNlcnZhYmxlPEVkaXRvclZpZXc+IHtcbiAgICByZXR1cm4gdGhpcy51cGRhdGVTdWJqZWN0LmFzT2JzZXJ2YWJsZSgpO1xuICB9XG5cbiAgZ2V0IHNjaGVtYSgpOiBTY2hlbWEge1xuICAgIHJldHVybiB0aGlzLm9wdGlvbnMuc2NoZW1hIHx8IGRlZmF1dGxTY2hlbWE7XG4gIH1cblxuICBnZXQgY29tbWFuZHMoKTogRWRpdG9yQ29tbWFuZHMge1xuICAgIHJldHVybiBuZXcgRWRpdG9yQ29tbWFuZHModGhpcy52aWV3KTtcbiAgfVxuXG4gIHNldENvbnRlbnQoY29udGVudDogQ29udGVudCk6IHZvaWQge1xuICAgIGlmIChpc05pbChjb250ZW50KSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHsgc3RhdGUgfSA9IHRoaXMudmlldztcbiAgICBjb25zdCB7IHRyLCBkb2MgfSA9IHN0YXRlO1xuXG4gICAgY29uc3QgbmV3RG9jID0gcGFyc2VDb250ZW50KGNvbnRlbnQsIHRoaXMuc2NoZW1hKTtcblxuICAgIHRyLnJlcGxhY2VXaXRoKDAsIHN0YXRlLmRvYy5jb250ZW50LnNpemUsIG5ld0RvYyk7XG5cbiAgICAvLyBkb24ndCBlbWl0IGlmIGJvdGggY29udGVudCBpcyBzYW1lXG4gICAgaWYgKGRvYy5lcSh0ci5kb2MpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKCF0ci5kb2NDaGFuZ2VkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy52aWV3LmRpc3BhdGNoKHRyKTtcbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlVHJhbnNhY3Rpb25zKHRyOiBUcmFuc2FjdGlvbik6IHZvaWQge1xuICAgIGNvbnN0IHN0YXRlID0gdGhpcy52aWV3LnN0YXRlLmFwcGx5KHRyKTtcbiAgICB0aGlzLnZpZXcudXBkYXRlU3RhdGUoc3RhdGUpO1xuXG4gICAgdGhpcy51cGRhdGVTdWJqZWN0Lm5leHQodGhpcy52aWV3KTtcblxuICAgIGlmICghdHIuZG9jQ2hhbmdlZCAmJiAhdHIuZ2V0TWV0YSgnRk9SQ0VfRU1JVCcpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QganNvbiA9IHN0YXRlLmRvYy50b0pTT04oKTtcbiAgICB0aGlzLnZhbHVlQ2hhbmdlc1N1YmplY3QubmV4dChqc29uKTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlRWRpdG9yKCk6IHZvaWQge1xuICAgIGNvbnN0IHsgb3B0aW9ucyB9ID0gdGhpcztcbiAgICBjb25zdCB7IGNvbnRlbnQgPSBudWxsLCBub2RlVmlld3MgfSA9IG9wdGlvbnM7XG4gICAgY29uc3QgeyBoaXN0b3J5ID0gdHJ1ZSwga2V5Ym9hcmRTaG9ydGN1dHMgPSB0cnVlLCBpbnB1dFJ1bGVzID0gdHJ1ZSB9ID0gb3B0aW9ucztcbiAgICBjb25zdCBzY2hlbWEgPSB0aGlzLnNjaGVtYTtcblxuICAgIGNvbnN0IGRvYyA9IHBhcnNlQ29udGVudChjb250ZW50LCBzY2hlbWEpO1xuXG4gICAgY29uc3QgcGx1Z2luczogUGx1Z2luW10gPSBvcHRpb25zLnBsdWdpbnMgPz8gW107XG5cbiAgICBjb25zdCBkZWZhdWx0UGx1Z2lucyA9IGdldERlZmF1bHRQbHVnaW5zKHNjaGVtYSwge1xuICAgICAgaGlzdG9yeSxcbiAgICAgIGtleWJvYXJkU2hvcnRjdXRzLFxuICAgICAgaW5wdXRSdWxlc1xuICAgIH0pO1xuXG4gICAgdGhpcy52aWV3ID0gbmV3IEVkaXRvclZpZXcobnVsbCwge1xuICAgICAgc3RhdGU6IEVkaXRvclN0YXRlLmNyZWF0ZSh7XG4gICAgICAgIGRvYyxcbiAgICAgICAgc2NoZW1hLFxuICAgICAgICBwbHVnaW5zOiBbLi4uZGVmYXVsdFBsdWdpbnMsIC4uLnBsdWdpbnMsIF0sXG4gICAgICB9KSxcbiAgICAgIG5vZGVWaWV3cyxcbiAgICAgIGRpc3BhdGNoVHJhbnNhY3Rpb246IHRoaXMuaGFuZGxlVHJhbnNhY3Rpb25zLmJpbmQodGhpcylcbiAgICB9KTtcbiAgfVxuXG4gIHJlZ2lzdGVyUGx1Z2luKHBsdWdpbjogUGx1Z2luKTogdm9pZCB7XG4gICAgY29uc3QgeyBzdGF0ZSB9ID0gdGhpcy52aWV3O1xuICAgIGNvbnN0IHBsdWdpbnMgPSBbLi4uc3RhdGUucGx1Z2lucywgcGx1Z2luXTtcblxuICAgIGNvbnN0IG5ld1N0YXRlID0gc3RhdGUucmVjb25maWd1cmUoeyBwbHVnaW5zIH0pO1xuICAgIHRoaXMudmlldy51cGRhdGVTdGF0ZShuZXdTdGF0ZSk7XG4gIH1cblxuICBkZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMudmlldy5kZXN0cm95KCk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgRWRpdG9yO1xuIl19